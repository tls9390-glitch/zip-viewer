name: Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.6'
          channel: 'stable'

      - name: Create launcher icon
        run: |
          python3 -c "
          import struct, zlib
          def make_png(size):
              def chunk(name, data):
                  c = struct.pack('>I', len(data)) + name + data
                  return c + struct.pack('>I', zlib.crc32(name + data) & 0xffffffff)
              sig = b'\x89PNG\r\n\x1a\n'
              ihdr = chunk(b'IHDR', struct.pack('>IIBBBBB', size, size, 8, 2, 0, 0, 0))
              row = b'\x00' + b'\x1a\x1a\x2e' * size
              idat = chunk(b'IDAT', zlib.compress(row * size))
              iend = chunk(b'IEND', b'')
              return sig + ihdr + idat + iend
          import os
          sizes = {'mdpi':48,'hdpi':72,'xhdpi':96,'xxhdpi':144,'xxxhdpi':192}
          for name, size in sizes.items():
              os.makedirs(f'zip_viewer/android/app/src/main/res/mipmap-{name}', exist_ok=True)
              with open(f'zip_viewer/android/app/src/main/res/mipmap-{name}/ic_launcher.png','wb') as f:
                  f.write(make_png(size))
          print('icons ok')
          "

      - name: Flutter pub get
        working-directory: zip_viewer
        run: flutter pub get

      - name: Build APK
        working-directory: zip_viewer
        run: flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: zip-viewer-apk
          path: zip_viewer/build/app/outputs/flutter-apk/app-release.apk
